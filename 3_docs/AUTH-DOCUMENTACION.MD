# ğŸ” SISTEMA DE AUTENTICACIÃ“N - DOCUMENTACIÃ“N

## ğŸ“¦ DEPENDENCIAS INSTALADAS

```bash
npm install bcrypt jsonwebtoken
```

## ğŸ‘¥ ROLES Y PERMISOS

|        Rol        |    CÃ³digo Sistema     |        Permisos      |         Acciones        |
|-------------------|-----------------------|----------------------|-------------------------|
| **VISITANTE**     |       `viewer`        |ğŸ” Solo lectura ğŸ”   | GET (consultar)         |
| **TICS**          |     `technician`      |  ğŸ”ğŸ” + âœï¸ + â•    | GET, POST, PUT          |
| **ADMINISTRADOR** |       `admin`         |  ğŸ” + âœï¸ + â• + ğŸ—‘ï¸ | GET, POST, PUT, DELETE  |

---

## ğŸ“ ARCHIVOS CREADOS

### 1. `backend/config/database.js`
- ConexiÃ³n a MySQL
- Pool de conexiones
- FunciÃ³n helper `query()`

### 2. `backend/middleware/auth.js`
- `authenticateToken()` - Verifica JWT
- `requireRole([roles])` - Verifica rol especÃ­fico
- `checkPermissions()` - Verifica permisos por mÃ©todo HTTP
- `protect()` - Middleware combinado

### 3. `backend/routes/auth.js`
- POST `/api/auth/login` - Iniciar sesiÃ³n
- POST `/api/auth/register` - Registrar usuario (admin)
- GET `/api/auth/me` - Info usuario actual
- PUT `/api/auth/change-password` - Cambiar contraseÃ±a
- GET `/api/auth/usuarios` - Listar usuarios (admin)
- PUT `/api/auth/usuarios/:id` - Actualizar usuario (admin)
- DELETE `/api/auth/usuarios/:id` - Desactivar usuario (admin)

### 4. `backend/scripts/crear-usuarios.js`
- Script para crear usuarios iniciales
- Encripta contraseÃ±as con bcrypt

---

## ğŸš€ CÃ“MO USAR

### 1. Configurar Variables de Entorno (.env)

```env
# JWT Secret (cambiar en producciÃ³n)
JWT_SECRET=tu-clave-super-secreta-y-larga-aqui-2025

# MySQL
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=tu_password
DB_NAME=tics_aeropuerto
```

### 2. Crear Usuarios Iniciales

```bash
node backend/scripts/crear-usuarios.js
```

**Resultado:**
```
ğŸ‘‘ ADMINISTRADOR: admin / admin123
ğŸ”§ TICS: tics / tics123
ğŸ‘ï¸  VISITANTE: visitante / visitante123
```

### 3. Proteger Rutas en el Backend

```javascript
const { authenticateToken, requireRole, protect } = require('../middleware/auth');

// Solo usuarios autenticados
router.get('/computadores', authenticateToken, getComputadores);

// Solo TICS y ADMIN pueden crear
router.post('/computadores', 
    authenticateToken, 
    requireRole(['technician', 'admin']), 
    createComputador
);

// Solo ADMIN puede eliminar
router.delete('/computadores/:id', 
    authenticateToken, 
    requireRole(['admin']), 
    deleteComputador
);

// Auto-verificar permisos segÃºn mÃ©todo HTTP
router.use('/computadores', protect);
```

---

## ğŸ”‘ FLUJO DE AUTENTICACIÃ“N

### 1. **Login (Frontend)**

```javascript
// POST /api/auth/login
const response = await fetch('http://localhost:3000/api/auth/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        username: 'admin',
        password: 'admin123'
    })
});

const data = await response.json();
// { success: true, token: "eyJhbGc...", usuario: {...} }

// Guardar token
localStorage.setItem('token', data.token);
localStorage.setItem('usuario', JSON.stringify(data.usuario));
```

### 2. **Usar Token en Peticiones**

```javascript
// Todas las peticiones despuÃ©s del login
const token = localStorage.getItem('token');

const response = await fetch('http://localhost:3000/api/computadores', {
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    }
});
```

### 3. **Verificar SesiÃ³n**

```javascript
// GET /api/auth/me
const response = await fetch('http://localhost:3000/api/auth/me', {
    headers: {
        'Authorization': `Bearer ${token}`
    }
});

const data = await response.json();
// { success: true, data: { nombre: "...", rol: "admin", ... } }
```

---

## ğŸ›¡ï¸ SEGURIDAD

### ContraseÃ±as
- âœ… Encriptadas con **bcrypt** (10 salt rounds)
- âœ… Nunca se almacenan en texto plano
- âœ… No se devuelven en las respuestas JSON

### JWT
- âœ… Firmado con clave secreta (JWT_SECRET)
- âœ… ExpiraciÃ³n de 24 horas
- âœ… Contiene: id, username, rol, nombre

### Base de Datos
- âœ… Tabla `Usuarios_sistema` separada de `Personas`
- âœ… Campo `activo` para desactivar sin eliminar
- âœ… Registro de `ultimo_acceso`

---

## ğŸ“Š EJEMPLOS DE RESPUESTAS

### Login Exitoso
```json
{
  "success": true,
  "message": "Inicio de sesiÃ³n exitoso",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "usuario": {
    "id": 1,
    "username": "admin",
    "nombre": "Administrador del Sistema",
    "rol": "admin",
    "correo": "admin@tics.com"
  }
}
```

### Login Fallido
```json
{
  "success": false,
  "error": "Usuario o contraseÃ±a incorrectos"
}
```

### Sin Permisos
```json
{
  "success": false,
  "error": "No tienes permisos para realizar esta acciÃ³n.",
  "rol_requerido": ["admin"],
  "tu_rol": "technician"
}
```

### Token Expirado
```json
{
  "success": false,
  "error": "Token invÃ¡lido o expirado."
}
```

---

## ğŸ”„ CAMBIAR CONTRASEÃ‘A

```javascript
// PUT /api/auth/change-password
const response = await fetch('http://localhost:3000/api/auth/change-password', {
    method: 'PUT',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        password_actual: 'admin123',
        password_nueva: 'nuevaPassword456'
    })
});
```

---

## ğŸ‘¨â€ğŸ’¼ GESTIÃ“N DE USUARIOS (Solo ADMIN)

### Listar Usuarios
```javascript
// GET /api/auth/usuarios
const response = await fetch('http://localhost:3000/api/auth/usuarios', {
    headers: { 'Authorization': `Bearer ${token}` }
});
```

### Actualizar Rol de Usuario
```javascript
// PUT /api/auth/usuarios/2
await fetch('http://localhost:3000/api/auth/usuarios/2', {
    method: 'PUT',
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        rol_sistema: 'admin'
    })
});
```

### Desactivar Usuario
```javascript
// DELETE /api/auth/usuarios/3
await fetch('http://localhost:3000/api/auth/usuarios/3', {
    method: 'DELETE',
    headers: { 'Authorization': `Bearer ${token}` }
});
```

---

## ğŸ¯ PRÃ“XIMOS PASOS

1. âœ… Ejecutar script de usuarios: `node backend/scripts/crear-usuarios.js`
2. âœ… Probar login con Postman o frontend
3. âœ… Proteger todas las rutas segÃºn roles
4. âœ… Implementar logout en frontend (borrar token)
5. âœ… Implementar refresh token (opcional)

---

## âš ï¸ IMPORTANTE

- **Cambiar JWT_SECRET** en producciÃ³n (usar algo mÃ¡s largo y aleatorio)
- **No subir .env a Git** (ya estÃ¡ en .gitignore)
- **HTTPS en producciÃ³n** (nunca enviar tokens por HTTP)
- **ExpiraciÃ³n de tokens** ajustable segÃºn necesidad

---

**Sistema listo para autenticaciÃ³n segura con 3 niveles de acceso** âœ…