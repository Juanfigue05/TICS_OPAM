<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        .dash-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        .stats-divider {
            display: flex;
            align-items: center;
            gap: .75rem;
            margin: .9rem 0 .4rem;
            font-size: .65rem;
            font-weight: 700;
            color: var(--clr-text-faint);
            text-transform: uppercase;
            letter-spacing: .1em;
        }
        .stats-divider::after { content:'';flex:1;height:1px;background:var(--clr-border); }

        .stat-card.stat-gesti√≥n .stat-icon { background:rgba(168,85,247,.15); }
        .stat-card.stat-gesti√≥n:hover { border-color:rgba(168,85,247,.3); }
        .stat-card.stat-total {
            border-color:rgba(43,127,255,.25);
            background:linear-gradient(135deg,rgba(43,127,255,.08),rgba(0,212,255,.05));
        }
        .stat-card.stat-total .stat-value,
        .stat-card.stat-total .stat-label { color:var(--clr-primary); }
        .stat-card.stat-total .stat-icon  { background:rgba(43,127,255,.2); }

        .sys-row {
            display:flex;align-items:center;gap:.75rem;
            padding:.6rem 0;border-bottom:1px solid var(--clr-border);font-size:.82rem;
        }
        .sys-row:last-child { border-bottom:none; }
        .sys-label { color:var(--clr-text-muted);flex:1; }

        .chart-wrap { position:relative;width:100%; }
        .chart-wrap canvas { display:block; }

        /* Asignados */
        .assign-row { display:flex;flex-direction:column;gap:.8rem; }
        .assign-header {
            display:flex;justify-content:space-between;
            align-items:baseline;margin-bottom:.3rem;
        }
        .assign-label {
            font-size:.78rem;font-weight:600;
            color:var(--clr-text-muted);display:flex;align-items:center;gap:.4rem;
        }
        .assign-nums { font-size:.72rem;color:var(--clr-text-faint);font-family:var(--font-mono); }
        .assign-bar-bg { height:7px;border-radius:10px;background:var(--clr-surface-2);overflow:hidden; }
        .assign-bar-fill {
            height:100%;border-radius:10px;
            background:linear-gradient(90deg,var(--clr-primary),#00d4ff);
            transition:width .8s cubic-bezier(.34,1.2,.64,1);
        }
        .assign-bar-fill.warn  { background:linear-gradient(90deg,#f59e0b,#fbbf24); }
        .assign-bar-fill.empty { background:var(--clr-surface-3); }

        /* Historial */
        .hist-list { display:flex;flex-direction:column; }
        .hist-item {
            display:flex;align-items:flex-start;gap:.65rem;
            padding:.6rem 0;border-bottom:1px solid var(--clr-border);font-size:.79rem;
        }
        .hist-item:last-child { border-bottom:none; }
        .hist-icon {
            width:28px;height:28px;border-radius:8px;
            display:flex;align-items:center;justify-content:center;
            font-size:.75rem;flex-shrink:0;
        }
        .hist-body { flex:1;min-width:0; }
        .hist-title {
            font-weight:600;color:var(--clr-text);
            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
        }
        .hist-sub {
            color:var(--clr-text-faint);font-size:.72rem;
            white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
        }
        .hist-time {
            font-size:.68rem;color:var(--clr-text-faint);
            font-family:var(--font-mono);flex-shrink:0;padding-top:1px;
        }
        .hist-empty {
            padding:2rem 0;text-align:center;
            color:var(--clr-text-faint);font-size:.82rem;
        }

        /* Roles */
        .roles-grid {
            display:grid;grid-template-columns:repeat(3,1fr);
            gap:.75rem;margin-top:.25rem;
        }
        .rol-card {
            border-radius:var(--r-sm);padding:1rem 1.1rem;
            border:1px solid var(--clr-border);
            display:flex;align-items:center;gap:.8rem;
        }
        .rol-icon {
            width:38px;height:38px;border-radius:10px;
            display:flex;align-items:center;justify-content:center;
            font-size:1rem;flex-shrink:0;
        }
        .rol-info { flex:1; }
        .rol-name {
            font-size:.7rem;color:var(--clr-text-muted);
            font-weight:600;text-transform:uppercase;letter-spacing:.05em;
        }
        .rol-count {
            font-size:1.5rem;font-weight:800;
            font-family:var(--font-display);line-height:1.2;
        }
        .rol-admin  { background:rgba(168,85,247,.08);border-color:rgba(168,85,247,.2); }
        .rol-admin  .rol-icon  { background:rgba(168,85,247,.15); }
        .rol-admin  .rol-count { color:#a855f7; }
        .rol-tics   { background:rgba(43,127,255,.06);border-color:rgba(43,127,255,.2); }
        .rol-tics   .rol-icon  { background:rgba(43,127,255,.15); }
        .rol-tics   .rol-count { color:var(--clr-primary); }
        .rol-visit  { background:rgba(100,116,139,.06);border-color:rgba(100,116,139,.2); }
        .rol-visit  .rol-icon  { background:rgba(100,116,139,.12); }
        .rol-visit  .rol-count { color:var(--clr-text-muted); }

        .skel { background:var(--clr-surface-2);border-radius:6px;animation:skel-pulse 1.4s ease infinite; }
        @keyframes skel-pulse { 0%,100%{opacity:.5}50%{opacity:1} }

        /* Marcas */
        .marca-row {
            display: flex;
            align-items: center;
            gap: .65rem;
            padding: .45rem 0;
            border-bottom: 1px solid var(--clr-border);
        }
        .marca-row:last-child { border-bottom: none; }
        .marca-rank {
            width: 18px;
            font-size: .68rem;
            font-weight: 700;
            color: var(--clr-text-faint);
            text-align: center;
            flex-shrink: 0;
        }
        .marca-rank.top1 { color: #f59e0b; }
        .marca-rank.top2 { color: #94a3b8; }
        .marca-rank.top3 { color: #b45309; }
        .marca-name {
            font-size: .8rem;
            font-weight: 600;
            color: var(--clr-text);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .marca-bar-wrap {
            flex: 2;
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .marca-bar-bg {
            flex: 1;
            height: 6px;
            border-radius: 10px;
            background: var(--clr-surface-2);
            overflow: hidden;
        }
        .marca-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width .7s cubic-bezier(.34,1.2,.64,1);
        }
        .marca-count {
            font-size: .72rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--clr-text-muted);
            width: 24px;
            text-align: right;
            flex-shrink: 0;
        }

        /* √öltimos equipos: badge tipo */
        .eq-tipo {
            display: inline-block;
            padding: .1rem .45rem;
            border-radius: 5px;
            font-size: .65rem;
            font-weight: 700;
            background: rgba(43,127,255,.12);
            color: var(--clr-primary);
            white-space: nowrap;
            flex-shrink: 0;
        }

        @media (max-width:900px)  { .dash-grid-2 { grid-template-columns:1fr; } }
        @media (max-width:560px)  { .roles-grid  { grid-template-columns:1fr; } }
    </style>
</head>
<body>
<div class="airport-layout">
    <div id="sidebar-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="app-main">

        <!-- Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--clr-primary)" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                </h1>
                <p class="page-subtitle" id="subtitleDash">Cargando inventario...</p>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="loadDashboard()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"/>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                Actualizar
            </button>
        </div>

        <!-- ‚îÄ‚îÄ Equipos TI ‚îÄ‚îÄ -->
        <div class="stats-divider">Equipos TI</div>
        <div class="stats-grid" id="statsEquipos" style="margin-bottom:.25rem;">
            <div class="stat-card" style="opacity:.35;pointer-events:none;"><div class="stat-icon"></div><div class="stat-value">‚Äî</div><div class="stat-label">Cargando...</div></div>
            <div class="stat-card" style="opacity:.35;pointer-events:none;"><div class="stat-icon"></div><div class="stat-value">‚Äî</div><div class="stat-label">Cargando...</div></div>
            <div class="stat-card" style="opacity:.35;pointer-events:none;"><div class="stat-icon"></div><div class="stat-value">‚Äî</div><div class="stat-label">Cargando...</div></div>
            <div class="stat-card" style="opacity:.35;pointer-events:none;"><div class="stat-icon"></div><div class="stat-value">‚Äî</div><div class="stat-label">Cargando...</div></div>
        </div>

        <!-- ‚îÄ‚îÄ Gesti√≥n ‚îÄ‚îÄ -->
        <div class="stats-divider">Gesti√≥n</div>
        <div class="stats-grid" id="statsGestion" style="margin-bottom:.25rem;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));">
            <div class="stat-card" style="opacity:.35;pointer-events:none;"><div class="stat-icon"></div><div class="stat-value">‚Äî</div><div class="stat-label">Cargando...</div></div>
        </div>

        <!-- ‚îÄ‚îÄ Distribuci√≥n + Estado del Sistema ‚îÄ‚îÄ -->
        <div class="stats-divider">Distribuci√≥n</div>
        <div class="dash-grid-2">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Distribuci√≥n de Equipos</span>
                    <span id="totalLabel" class="text-faint font-mono" style="font-size:.7rem;"></span>
                </div>
                <div class="chart-wrap" style="height:230px;display:flex;align-items:center;justify-content:center;">
                    <canvas id="donutChart"></canvas>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Estado del Sistema</span>
                    <span id="lastUpdate" class="text-faint font-mono" style="font-size:.7rem;"></span>
                </div>
                <div id="sysStatusRows">
                    <div class="sys-row"><span class="status-pulse"></span><span class="sys-label">Servidor API</span><span class="sys-value text-success">Activo</span></div>
                    <div class="sys-row"><span class="status-pulse"></span><span class="sys-label">Base de Datos TiDB</span><span class="sys-value" id="dbStatus" style="color:var(--clr-text-faint);">Verificando...</span></div>
                    <div class="sys-row">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--clr-text-faint)" stroke-width="2" style="flex-shrink:0;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span class="sys-label">Zona horaria</span><span class="sys-value text-muted">America/Bogot√°</span>
                    </div>
                    <div class="sys-row">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--clr-text-faint)" stroke-width="2" style="flex-shrink:0;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span class="sys-label">Autenticaci√≥n JWT</span><span class="sys-value text-success">Activa</span>
                    </div>
                    <div class="sys-row">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--clr-text-faint)" stroke-width="2" style="flex-shrink:0;"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        <span class="sys-label">√öltima actualizaci√≥n</span>
                        <span class="sys-value text-muted font-mono" id="lastSync" style="font-size:.75rem;">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Equipos por ubicaci√≥n ‚îÄ‚îÄ -->
        <div class="stats-divider">Ubicaciones</div>
        <div class="card">
            <div class="card-header">
                <span class="card-title">Equipos por Ubicaci√≥n</span>
                <span class="text-faint" style="font-size:.72rem;">Top ubicaciones con m√°s equipos asignados</span>
            </div>
            <div class="chart-wrap" style="height:240px;">
                <canvas id="ubicChart"></canvas>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Asignados vs sin asignar + Actividad reciente ‚îÄ‚îÄ -->
        <div class="stats-divider">Asignaci√≥n &amp; Actividad</div>
        <div class="dash-grid-2">
            <div class="card">
                <div class="card-header"><span class="card-title">Asignados vs Sin Asignar</span></div>
                <div class="assign-row" id="assignRows">
                    <div class="skel" style="height:38px;"></div>
                    <div class="skel" style="height:38px;margin-top:.5rem;"></div>
                    <div class="skel" style="height:38px;margin-top:.5rem;"></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Actividad Reciente</span>
                    <a href="/pages/historial.html" style="font-size:.72rem;color:var(--clr-primary);text-decoration:none;">Ver todo ‚Üí</a>
                </div>
                <div class="hist-list" id="histList">
                    <div class="hist-empty">Cargando actividad...</div>
                </div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ √öltimos equipos registrados ‚îÄ‚îÄ -->
        <div class="stats-divider">Nuevos Ingresos</div>
        <div class="card">
            <div class="card-header">
                <span class="card-title">√öltimos Equipos Registrados</span>
                <span class="text-faint" style="font-size:.72rem;">M√°s recientes en el inventario</span>
            </div>
            <div class="hist-list" id="ultimosList" style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
                <div class="hist-empty" style="grid-column:1/-1;">Cargando...</div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Personal por rol ‚îÄ‚îÄ -->
        <div class="stats-divider">Personal</div>
        <div class="card">
            <div class="card-header">
                <span class="card-title">Distribuci√≥n del Personal</span>
                <a href="/pages/persona.html" style="font-size:.72rem;color:var(--clr-primary);text-decoration:none;">Gestionar ‚Üí</a>
            </div>
            <div class="roles-grid" id="rolesGrid">
                <div class="skel" style="height:70px;border-radius:10px;"></div>
                <div class="skel" style="height:70px;border-radius:10px;"></div>
                <div class="skel" style="height:70px;border-radius:10px;"></div>
            </div>
        </div>

    </main>
    <div id="footer-placeholder"></div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
const EQUIPOS_CFG = [
    { key:'computadores', label:'Computadores', icon:'üíª', href:'/pages/computador.html',  color:'#2b7fff' },
    { key:'celulares',    label:'Celulares',    icon:'üì±', href:'/pages/celular.html',     color:'#00d4ff' },
    { key:'impresoras',   label:'Impresoras',   icon:'üñ®Ô∏è', href:'/pages/impresora.html',   color:'#a855f7' },
    { key:'radios',       label:'Radios',        icon:'üìª', href:'/pages/radio.html',       color:'#f59e0b' },
    { key:'telefonos_ip', label:'Tel√©fonos IP',  icon:'üìû', href:'/pages/telefono_ip.html', color:'#10b981' },
    { key:'tablets',      label:'Tablets',       icon:'üì≤', href:'/pages/tablet.html',      color:'#ef4444' },
    { key:'accesorios',   label:'Accesorios',    icon:'üîå', href:'/pages/accesorios.html',  color:'#6366f1' },
];

let donutChart = null, ubicChart = null;

Chart.defaults.color       = '#94a3b8';
Chart.defaults.borderColor = 'rgba(255,255,255,0.07)';
Chart.defaults.font.family = "'Inter','Manrope',sans-serif";
Chart.defaults.font.size   = 11;
Chart.defaults.plugins.legend.labels.boxWidth = 10;
Chart.defaults.plugins.legend.labels.padding  = 12;

/* ‚îÄ‚îÄ Main loader ‚îÄ‚îÄ */
async function loadDashboard() {
    try {
        const res = await API.request('/dashboard');
        if (!res.success) throw new Error('Error en respuesta');
        const d = res.data;

        renderStatCards(d.stats);
        renderGestion(d.personas);
        renderDonut(d.stats);
        renderUbicaciones(d.porUbicacion);
        renderAsignacion(d.asignacion);
        renderHistorial(d.historial);
        renderRoles(d.personasPorRol);
        renderUltimos(d.ultimosEquipos);

        document.getElementById('dbStatus').textContent = '‚úì Conectada';
        document.getElementById('dbStatus').style.color = 'var(--clr-success)';
        const now = new Date().toLocaleTimeString('es-CO');
        document.getElementById('lastUpdate').textContent = now;
        document.getElementById('lastSync').textContent   = now;
        const total = d.stats.total || 0;
        document.getElementById('subtitleDash').textContent =
            `${total} equipo${total !== 1 ? 's' : ''} activo${total !== 1 ? 's' : ''} en el inventario ¬∑ ${now}`;

    } catch(err) {
        console.error('Dashboard error:', err);
        document.getElementById('subtitleDash').textContent = 'Error al cargar datos';
    }
}

/* ‚îÄ‚îÄ Stat cards equipos ‚îÄ‚îÄ */
function renderStatCards(stats) {
    document.getElementById('statsEquipos').innerHTML =
        EQUIPOS_CFG.map(cfg => `
            <a href="${cfg.href}" class="stat-card" style="text-decoration:none;">
                <div class="stat-icon">${cfg.icon}</div>
                <div class="stat-value">${stats[cfg.key] ?? 0}</div>
                <div class="stat-label">${cfg.label}</div>
            </a>`).join('') +
        `<div class="stat-card stat-total">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value">${stats.total || 0}</div>
            <div class="stat-label">Total Equipos</div>
        </div>`;
}

/* ‚îÄ‚îÄ Stat cards gesti√≥n ‚îÄ‚îÄ */
function renderGestion(personas) {
    const activas   = Number(personas?.activas ?? 0);
    const total     = Number(personas?.total   ?? 0);
    const inactivas = total - activas;
    document.getElementById('statsGestion').innerHTML = `
        <a href="/pages/persona.html" class="stat-card stat-gesti√≥n" style="text-decoration:none;">
            <div class="stat-icon">üë•</div>
            <div class="stat-value">${activas}</div>
            <div class="stat-label">Personas Activas</div>
        </a>
        <div class="stat-card" style="pointer-events:none;">
            <div class="stat-icon">üîí</div>
            <div class="stat-value">${inactivas}</div>
            <div class="stat-label">Inactivas</div>
        </div>`;
}

/* ‚îÄ‚îÄ Donut chart ‚îÄ‚îÄ */
function renderDonut(stats) {
    const labels = EQUIPOS_CFG.map(c => c.label);
    const data   = EQUIPOS_CFG.map(c => Number(stats[c.key] || 0));
    const colors = EQUIPOS_CFG.map(c => c.color);

    if (donutChart) { donutChart.destroy(); donutChart = null; }
    document.getElementById('totalLabel').textContent = `Total: ${stats.total || 0}`;

    donutChart = new Chart(document.getElementById('donutChart'), {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{ data, backgroundColor: colors.map(c => c + 'cc'), borderColor: colors, borderWidth: 1.5, hoverOffset: 6 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '68%',
            plugins: {
                legend: { position: 'right', labels: { pointStyle: 'circle', usePointStyle: true } },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const total = stats.total || 1;
                            return ` ${ctx.label}: ${ctx.parsed} (${((ctx.parsed/total)*100).toFixed(1)}%)`;
                        }
                    }
                }
            }
        }
    });
}

/* ‚îÄ‚îÄ Barras horizontales por ubicaci√≥n ‚îÄ‚îÄ */
function renderUbicaciones(data) {
    const wrap = document.getElementById('ubicChart').closest('.card');
    if (!data || !data.length) {
        wrap.querySelector('.chart-wrap').innerHTML =
            '<div style="padding:3rem;text-align:center;color:var(--clr-text-faint);font-size:.82rem;">Sin datos de ubicaci√≥n a√∫n</div>';
        return;
    }
    const palette = ['#2b7fff','#00d4ff','#a855f7','#10b981','#f59e0b','#ef4444','#6366f1','#ec4899'];
    if (ubicChart) { ubicChart.destroy(); ubicChart = null; }

    ubicChart = new Chart(document.getElementById('ubicChart'), {
        type: 'bar',
        data: {
            labels: data.map(r => r.nombre || 'Sin nombre'),
            datasets: [{
                label: 'Equipos asignados',
                data: data.map(r => Number(r.total)),
                backgroundColor: palette.slice(0, data.length).map(c => c + 'bb'),
                borderColor:     palette.slice(0, data.length),
                borderWidth: 1, borderRadius: 6, borderSkipped: false
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.x} equipo${ctx.parsed.x !== 1 ? 's' : ''}` } }
            },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, grid: { color: 'rgba(255,255,255,0.05)' } },
                y: { grid: { display: false }, ticks: { font: { size: 11 } } }
            }
        }
    });
}

/* ‚îÄ‚îÄ Barras de asignaci√≥n ‚îÄ‚îÄ */
function renderAsignacion(a) {
    if (!a) { document.getElementById('assignRows').innerHTML = '<div class="hist-empty">Sin datos</div>'; return; }
    const items = [
        { label:'Computadores', icon:'üíª', total:+a.comp_total,   asig:+a.comp_asig   },
        { label:'Celulares',    icon:'üì±', total:+a.cel_total,    asig:+a.cel_asig    },
        { label:'Radios',       icon:'üìª', total:+a.radio_total,  asig:+a.radio_asig  },
        { label:'Tablets',      icon:'üì≤', total:+a.tablet_total, asig:+a.tablet_asig },
        { label:'Tel√©fonos IP', icon:'üìû', total:+a.tel_total,    asig:+a.tel_asig    },
    ].filter(i => i.total > 0);

    if (!items.length) { document.getElementById('assignRows').innerHTML = '<div class="hist-empty">Sin datos de asignaci√≥n</div>'; return; }

    document.getElementById('assignRows').innerHTML = items.map(item => {
        const pct     = item.total > 0 ? Math.round((item.asig / item.total) * 100) : 0;
        const sinAsig = item.total - item.asig;
        const cls     = pct === 0 ? 'empty' : pct < 40 ? 'warn' : '';
        return `<div class="assign-item">
            <div class="assign-header">
                <span class="assign-label">${item.icon} ${item.label}</span>
                <span class="assign-nums">${item.asig}/${item.total} ¬∑ ${sinAsig} libre${sinAsig !== 1 ? 's' : ''}</span>
            </div>
            <div class="assign-bar-bg">
                <div class="assign-bar-fill ${cls}" style="width:${pct}%"></div>
            </div>
        </div>`;
    }).join('');
}

/* ‚îÄ‚îÄ Historial reciente ‚îÄ‚îÄ */
const ACCION_CFG = {
    'ASIGNACION':    { icon:'üì§', bg:'rgba(16,185,129,.15)',  color:'#10b981' },
    'DEVOLUCION':    { icon:'üì•', bg:'rgba(99,102,241,.15)',  color:'#6366f1' },
    'MANTENIMIENTO': { icon:'üîß', bg:'rgba(245,158,11,.15)',  color:'#f59e0b' },
    'DADO DE BAJA':  { icon:'üóëÔ∏è', bg:'rgba(239,68,68,.15)',   color:'#ef4444' },
    'REACTIVACION':  { icon:'‚úÖ', bg:'rgba(34,197,94,.15)',   color:'#22c55e' },
    'REEMPLAZO':     { icon:'üîÑ', bg:'rgba(168,85,247,.15)',  color:'#a855f7' },
};

function renderHistorial(rows) {
    if (!rows || !rows.length) {
        document.getElementById('histList').innerHTML = '<div class="hist-empty">üìã Sin actividad registrada a√∫n</div>';
        return;
    }
    document.getElementById('histList').innerHTML = rows.map(r => {
        const cfg  = ACCION_CFG[r.tipo_accion] || { icon:'‚Ä¢', bg:'rgba(100,116,139,.15)', color:'#64748b' };
        const when = r.fecha_accion ? timeAgo(new Date(r.fecha_accion)) : '‚Äî';
        const tipo = (r.tipo_equipo || '').replace('_', ' ');
        return `<div class="hist-item">
            <div class="hist-icon" style="background:${cfg.bg};color:${cfg.color};">${cfg.icon}</div>
            <div class="hist-body">
                <div class="hist-title">${r.tipo_accion} ¬∑ ${tipo}</div>
                <div class="hist-sub">${r.persona || 'Sin persona'} ¬∑ ${r.ubicacion || 'Sin ubicaci√≥n'}</div>
            </div>
            <div class="hist-time">${when}</div>
        </div>`;
    }).join('');
}

/* ‚îÄ‚îÄ Personas por rol ‚îÄ‚îÄ */
function renderRoles(rows) {
    const map = { ADMINISTRADOR: 0, TICS: 0, VISITANTE: 0 };
    (rows || []).forEach(r => { if (r.rol in map) map[r.rol] = +r.cantidad; });
    document.getElementById('rolesGrid').innerHTML = `
        <div class="rol-card rol-admin">
            <div class="rol-icon">üëë</div>
            <div class="rol-info">
                <div class="rol-name">Administradores</div>
                <div class="rol-count">${map.ADMINISTRADOR}</div>
            </div>
        </div>
        <div class="rol-card rol-tics">
            <div class="rol-icon">üõ†Ô∏è</div>
            <div class="rol-info">
                <div class="rol-name">T√©cnicos TICS</div>
                <div class="rol-count">${map.TICS}</div>
            </div>
        </div>
        <div class="rol-card rol-visit">
            <div class="rol-icon">ü™™</div>
            <div class="rol-info">
                <div class="rol-name">Visitantes</div>
                <div class="rol-count">${map.VISITANTE}</div>
            </div>
        </div>`;
}

/* ‚îÄ‚îÄ √öltimos equipos registrados ‚îÄ‚îÄ */
const TIPO_ICONS = {
    'Computador':  { icon:'üíª', color:'#2b7fff' },
    'Celular':     { icon:'üì±', color:'#00d4ff' },
    'Impresora':   { icon:'üñ®Ô∏è', color:'#a855f7' },
    'Radio':       { icon:'üìª', color:'#f59e0b' },
    'Tel√©fono IP': { icon:'üìû', color:'#10b981' },
    'Tablet':      { icon:'üì≤', color:'#ef4444' },
    'Accesorio':   { icon:'üîå', color:'#6366f1' },
};

function renderUltimos(rows) {
    const el = document.getElementById('ultimosList');
    if (!rows || !rows.length) {
        el.innerHTML = '<div class="hist-empty" style="grid-column:1/-1;">üì¶ Sin equipos registrados a√∫n</div>';
        return;
    }
    el.innerHTML = rows.map(r => {
        const cfg   = TIPO_ICONS[r.tipo] || { icon:'üì¶', color:'#64748b' };
        const when  = r.fecha_creacion ? timeAgo(new Date(r.fecha_creacion)) : '‚Äî';
        const marca = r.marca ? `${r.marca}${r.modelo ? ' ¬∑ ' + r.modelo : ''}` : '‚Äî';
        return `<div class="hist-item">
            <div class="hist-icon" style="background:${cfg.color}1a;color:${cfg.color};">${cfg.icon}</div>
            <div class="hist-body">
                <div class="hist-title">${r.nombre || '‚Äî'}</div>
                <div class="hist-sub"><span class="eq-tipo">${r.tipo}</span>&nbsp; ${marca}</div>
            </div>
            <div class="hist-time">${when}</div>
        </div>`;
    }).join('');
}

/* ‚îÄ‚îÄ Top marcas ‚îÄ‚îÄ */
const MARCA_COLORS = [
    '#2b7fff','#00d4ff','#a855f7','#10b981',
    '#f59e0b','#ef4444','#6366f1','#ec4899'
];

function renderMarcas(rows) {
    if (!rows || !rows.length) {
        document.getElementById('marcasWrap').innerHTML =
            '<div class="hist-empty">Sin datos de marcas</div>';
        return;
    }
    const maxVal = Math.max(...rows.map(r => Number(r.total)), 1);
    const ranks  = ['top1','top2','top3'];
    document.getElementById('marcasWrap').innerHTML = rows.map((r, i) => {
        const pct   = Math.round((Number(r.total) / maxVal) * 100);
        const color = MARCA_COLORS[i] || '#64748b';
        return `<div class="marca-row">
            <div class="marca-rank ${ranks[i] || ''}">${i + 1}</div>
            <div class="marca-name">${r.marca}</div>
            <div class="marca-bar-wrap">
                <div class="marca-bar-bg">
                    <div class="marca-bar-fill" style="width:${pct}%;background:${color};"></div>
                </div>
                <div class="marca-count">${r.total}</div>
            </div>
        </div>`;
    }).join('');
}

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function timeAgo(date) {
    const s = (Date.now() - date.getTime()) / 1000;
    if (s < 60)     return 'Ahora';
    if (s < 3600)   return `${Math.floor(s/60)}m`;
    if (s < 86400)  return `${Math.floor(s/3600)}h`;
    if (s < 604800) return `${Math.floor(s/86400)}d`;
    return date.toLocaleDateString('es-CO', { day:'2-digit', month:'short' });
}

loadComponents('dashboard');
loadDashboard();
</script>
</body>
</html>