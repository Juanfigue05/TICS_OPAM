<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personas ‚Äî TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
</head>
<body>
<div class="airport-layout">
    <div id="sidebar-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="app-main">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--clr-primary)" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Personas
                </h1>
                <p class="page-subtitle" id="subtitleCount">Cargando...</p>
            </div>
            <div class="flex gap-3 items-center flex-wrap">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="search" id="searchInput" placeholder="Buscar persona...">
                </div>
                <select id="filterRol" style="width:auto;padding:.55rem .9rem;">
                    <option value="">Todos los roles</option>
                    <option value="ADMINISTRADOR">Administrador</option>
                    <option value="TICS">TICS</option>
                    <option value="VISITANTE">Visitante</option>
                </select>
                <select id="filterActivo" style="width:auto;padding:.55rem .9rem;">
                    <option value="">Activos e inactivos</option>
                    <option value="1" selected>Solo activos</option>
                    <option value="0">Solo inactivos</option>
                </select>
                <button class="btn btn-primary" onclick="openModal('create')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nueva Persona
                </button>
            </div>
        </div>

        <div class="card" style="padding:0;overflow:hidden;">
            <div class="table-wrapper" style="border:none;border-radius:0;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th class="col-hide-mobile">Correo</th>
                            <th>Cargo</th>
                            <th>Rol</th>
                            <th class="col-hide-mobile">Celular</th>
                            <th class="col-hide-mobile">Extensi√≥n</th>
                            <th class="col-hide-mobile">√Årea</th>
                            <th>Estado</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr class="loading-row">
                            <td colspan="9"><div class="loader"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal" style="max-width:600px;">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Nueva Persona</span>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="itemForm">
                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Nombre completo *</label>
                        <input type="text" id="nombre" placeholder="Ej: Juan P√©rez" required>
                    </div>
                    <div class="form-group">
                        <label>Correo Corporativo</label>
                        <input type="email" id="correo_asignado" placeholder="usuario@aeropuerto.gov.co">
                    </div>
                </div>

                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Cargo</label>
                        <input type="text" id="cargo" placeholder="Analista, Jefe...">
                    </div>
                    <div class="form-group">
                        <label>Rol en el Sistema</label>
                        <!-- ENUM: ADMINISTRADOR | TICS | VISITANTE -->
                        <select id="rol">
                            <option value="VISITANTE" selected>Visitante</option>
                            <option value="TICS">TICS</option>
                            <option value="ADMINISTRADOR">Administrador</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>√Årea / Dependencia</label>
                        <input type="text" id="area" placeholder="TICS, Administraci√≥n...">
                    </div>
                </div>

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Celular</label>
                        <input type="tel" id="celular" placeholder="310 000 0000">
                    </div>
                    <div class="form-group">
                        <label>Extensi√≥n Telef√≥nica</label>
                        <input type="text" id="extension" placeholder="101" style="font-family:var(--font-mono);">
                    </div>
                </div>

                <div class="form-group">
                    <label>Estado</label>
                    <!-- activo es BOOLEAN en la BD -->
                    <select id="activo">
                        <option value="true" selected>Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" id="saveBtn" onclick="saveItem()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar
            </button>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
let allData = [], currentId = null;
const FIELDS = ['nombre','correo_asignado','cargo','rol','area','celular','extension','activo'];

async function loadData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = `<tr class="loading-row"><td colspan="9"><div class="loader"></div></td></tr>`;
    try {
        const res = await API.request('/personas');
        allData = res.data || [];
        applyFilters();
        const total = allData.length;
        const activos = allData.filter(p => p.activo === true || p.activo === 1).length;
        document.getElementById('subtitleCount').textContent =
            `${total} persona${total !== 1 ? 's' : ''} registrada${total !== 1 ? 's' : ''} ¬∑ ${activos} activa${activos !== 1 ? 's' : ''}`;
    } catch(e) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-muted" style="text-align:center;padding:2rem;">Error al cargar datos</td></tr>`;
    }
}

/* activo es BOOLEAN ‚Äî 1/true = activo, 0/false = inactivo */
function getBadgeActivo(activo) {
    const isActive = activo === true || activo === 1;
    return isActive
        ? '<span class="badge badge-activo">Activo</span>'
        : '<span class="badge badge-dadodebaja">Inactivo</span>';
}

function getRolBadge(rol) {
    if (!rol) return '<span class="badge badge-storage">‚Äî</span>';
    const cls = { ADMINISTRADOR: 'badge-administrador', TICS: 'badge-tics', VISITANTE: 'badge-visitante' };
    return `<span class="badge ${cls[rol] || 'badge-storage'}">${rol}</span>`;
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="9">
            <div class="empty-state">
                <div class="empty-state-icon">üë•</div>
                <div class="empty-state-title">Sin personas registradas</div>
                <div class="empty-state-sub">Agrega la primera con el bot√≥n "Nueva Persona"</div>
            </div>
        </td></tr>`;
        return;
    }
    tbody.innerHTML = data.map(d => `
        <tr class="animate-fade">
            <td>
                <div style="display:flex;align-items:center;gap:.65rem;">
                    <div style="width:30px;height:30px;border-radius:50%;background:${avatarColor(d.nombre)};
                         display:flex;align-items:center;justify-content:center;
                         font-size:.7rem;font-weight:700;color:white;font-family:var(--font-display);flex-shrink:0;">
                        ${initials(d.nombre)}
                    </div>
                    <span style="font-weight:500;">${d.nombre || '‚Äî'}</span>
                </div>
            </td>
            <td class="col-hide-mobile">
                ${d.correo_asignado
                    ? `<a href="mailto:${d.correo_asignado}" style="color:var(--clr-primary);font-size:.8rem;">${d.correo_asignado}</a>`
                    : '<span class="text-faint">‚Äî</span>'}
            </td>
            <td>${d.cargo || '<span class="text-faint">Sin asignar</span>'}</td>
            <td>${getRolBadge(d.rol)}</td>
            <td class="col-hide-mobile"><span class="font-mono">${d.celular || '‚Äî'}</span></td>
            <td class="col-hide-mobile"><span class="font-mono">${d.extension || '‚Äî'}</span></td>
            <td class="col-hide-mobile">${d.area || '<span class="text-faint">‚Äî</span>'}</td>
            <td>${getBadgeActivo(d.activo)}</td>
            <td style="text-align:center;">
                <div class="flex gap-2" style="justify-content:center;">
                    <button class="btn btn-ghost btn-sm btn-icon" onclick="editItem(${d.id_persona})" title="Editar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="btn btn-danger btn-sm btn-icon"
                        onclick="toggleActivo(${d.id_persona}, ${d.activo})"
                        title="${d.activo ? 'Desactivar' : 'Activar'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            ${d.activo
                                ? '<path d="M17 7 7 17M7 7l10 10"/>'
                                : '<path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/>'}
                        </svg>
                    </button>
                </div>
            </td>
        </tr>`).join('');
}

/* Helpers avatar */
function initials(name) {
    if (!name) return '?';
    return name.split(' ').map(n => n[0]).slice(0,2).join('').toUpperCase();
}
function avatarColor(name) {
    if (!name) return '#374151';
    let h = 0;
    for (let i = 0; i < name.length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
    return `hsl(${Math.abs(h) % 340}, 55%, 40%)`;
}

/* Filtros */
function applyFilters() {
    const s   = document.getElementById('searchInput').value.toLowerCase();
    const rol = document.getElementById('filterRol').value;
    const act = document.getElementById('filterActivo').value;
    renderTable(allData.filter(d => {
        const matchSearch = !s || [d.nombre, d.correo_asignado, d.cargo, d.area].some(v => (v||'').toLowerCase().includes(s));
        const matchRol    = !rol || d.rol === rol;
        const matchActivo = act === '' || String(d.activo === true || d.activo === 1 ? 1 : 0) === act;
        return matchSearch && matchRol && matchActivo;
    }));
}
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('filterRol').addEventListener('change', applyFilters);
document.getElementById('filterActivo').addEventListener('change', applyFilters);

/* Modal */
async function openModal(mode, id = null) {
    currentId = id;
    document.getElementById('modalTitle').textContent = mode === 'create' ? 'Nueva Persona' : 'Editar Persona';
    document.getElementById('itemForm').reset();
    if (mode === 'edit' && id) {
        const d = allData.find(p => p.id_persona === id);
        if (d) {
            FIELDS.forEach(f => {
                const el = document.getElementById(f);
                if (!el) return;
                if (f === 'activo') el.value = (d.activo === true || d.activo === 1) ? 'true' : 'false';
                else if (d[f] != null) el.value = d[f];
            });
        }
    }
    document.getElementById('modalOverlay').classList.add('open');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); currentId = null; }
document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

async function saveItem() {
    const g = id => document.getElementById(id)?.value || null;
    const data = {
        nombre:           g('nombre'),
        correo_asignado:  g('correo_asignado'),
        cargo:            g('cargo'),
        rol:              g('rol'),
        area:             g('area'),
        celular:          g('celular'),
        extension:        g('extension'),
        activo:           g('activo') === 'true',   // ‚Üê boolean para la BD
    };
    if (!data.nombre) { showError('El nombre es obligatorio.'); return; }
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Guardando...';
    try {
        if (currentId) {
            await API.request(`/personas/${currentId}`, { method: 'PUT', body: JSON.stringify(data) });
            showSuccess('Persona actualizada.');
        } else {
            await API.request('/personas', { method: 'POST', body: JSON.stringify(data) });
            showSuccess('Persona registrada.');
        }
        closeModal();
        loadData();
    } catch(err) {
        showError('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Guardar';
    }
}

function editItem(id) { openModal('edit', id); }

async function toggleActivo(id, currentActivo) {
    const isActive = currentActivo === true || currentActivo === 1;
    const accion   = isActive ? 'desactivar' : 'activar';
    if (!confirm(`¬øConfirmas ${accion} esta persona?`)) return;
    try {
        await API.request(`/personas/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ activo: !isActive })
        });
        showSuccess(`Persona ${isActive ? 'desactivada' : 'activada'}.`);
        loadData();
    } catch(err) {
        showError('Error: ' + err.message);
    }
}

loadComponents('persona');
loadData();
</script>
</body>
</html>