<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ubicaciones ‚Äî TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
    <style>
        /* Indicador de color de la ubicaci√≥n */
        .loc-color-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
            border: 1px solid rgba(255,255,255,0.15);
        }
        /* Preview color en el input */
        .color-input-wrap { display: flex; align-items: center; gap: .5rem; }
        .color-swatch {
            width: 32px; height: 32px;
            border-radius: var(--r-sm);
            border: 1px solid var(--clr-border-light);
            cursor: pointer; flex-shrink: 0;
        }
    </style>
</head>
<body>
<div class="airport-layout">
    <div id="sidebar-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="app-main">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--clr-primary)" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Ubicaciones
                </h1>
                <p class="page-subtitle" id="subtitleCount">Cargando...</p>
            </div>
            <div class="flex gap-3 items-center flex-wrap">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="search" id="searchInput" placeholder="Buscar ubicaci√≥n...">
                </div>
                <select id="filterActivo" style="width:auto;padding:.55rem .9rem;">
                    <option value="1" selected>Solo activas</option>
                    <option value="0">Inactivas</option>
                    <option value="">Todas</option>
                </select>
                <button class="btn btn-primary" onclick="openModal('create')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nueva Ubicaci√≥n
                </button>
            </div>
        </div>

        <div class="card" style="padding:0;overflow:hidden;">
            <div class="table-wrapper" style="border:none;border-radius:0;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>√Årea</th>
                            <th class="col-hide-mobile">Piso</th>
                            <th class="col-hide-mobile">Color</th>
                            <th class="col-hide-mobile">Equipos</th>
                            <th>Estado</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr class="loading-row"><td colspan="7"><div class="loader"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal" style="max-width:560px;">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Nueva Ubicaci√≥n</span>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form id="itemForm">
                <div class="form-group">
                    <label>Nombre de la Ubicaci√≥n *</label>
                    <input type="text" id="Nombre_ubicacion" placeholder="Ej: Torre de Control, Gate 12, Sala TICS" required>
                </div>

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>√Årea / Zona</label>
                        <input type="text" id="Area" placeholder="Terminal 1, Zona P√∫blica...">
                    </div>
                    <div class="form-group">
                        <label>Piso</label>
                        <input type="number" id="piso" placeholder="0, 1, 2..." min="0" max="20">
                    </div>
                </div>

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Color identificador</label>
                        <div class="color-input-wrap">
                            <input type="color" id="colorPicker" value="#2B7FFF"
                                style="width:32px;height:32px;border:1px solid var(--clr-border-light);border-radius:var(--r-sm);padding:2px;background:transparent;cursor:pointer;"
                                oninput="document.getElementById('color').value=this.value">
                            <input type="text" id="color" value="#2B7FFF" placeholder="#2B7FFF"
                                style="flex:1;font-family:var(--font-mono);"
                                oninput="syncColor(this.value)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Icono / Etiqueta</label>
                        <input type="text" id="icono" value="building" placeholder="building, gate, tower...">
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="descripcion" placeholder="Detalles adicionales de la ubicaci√≥n..."></textarea>
                </div>

                <div class="form-group">
                    <label>Estado</label>
                    <select id="activo">
                        <option value="true" selected>Activa</option>
                        <option value="false">Inactiva</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" id="saveBtn" onclick="saveItem()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar
            </button>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
let allData = [], currentId = null;
const FIELDS = ['Nombre_ubicacion','Area','piso','icono','color','descripcion','activo'];

/* Sincroniza el color picker con el input texto */
function syncColor(hex) {
    const picker = document.getElementById('colorPicker');
    if (/^#[0-9A-Fa-f]{6}$/.test(hex)) picker.value = hex;
}

async function loadData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = `<tr class="loading-row"><td colspan="7"><div class="loader"></div></td></tr>`;
    try {
        const res = await API.request('/ubicaciones');
        allData = res.data || [];
        applyFilters();
        const total   = allData.length;
        const activas = allData.filter(u => u.activo === true || u.activo === 1).length;
        document.getElementById('subtitleCount').textContent =
            `${total} ubicaci√≥n${total !== 1 ? 'es' : ''} ¬∑ ${activas} activa${activas !== 1 ? 's' : ''}`;
    } catch(e) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-muted" style="text-align:center;padding:2rem;">Error al cargar datos</td></tr>`;
    }
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="7">
            <div class="empty-state">
                <div class="empty-state-icon">üìç</div>
                <div class="empty-state-title">Sin ubicaciones registradas</div>
                <div class="empty-state-sub">Agrega la primera con "Nueva Ubicaci√≥n"</div>
            </div>
        </td></tr>`;
        return;
    }
    tbody.innerHTML = data.map(d => {
        const isActive = d.activo === true || d.activo === 1;
        const colorHex = d.color || '#2B7FFF';
        /* Total de equipos: puede venir del backend como d.equipos o d.total_equipos */
        const totalEq  = d.equipos?.total ?? d.total_equipos ?? '‚Äî';
        return `
        <tr class="animate-fade">
            <td>
                <div class="flex items-center gap-2">
                    <span class="loc-color-dot" style="background:${colorHex};"></span>
                    <span style="font-weight:500;">${d.Nombre_ubicacion || '‚Äî'}</span>
                </div>
            </td>
            <td>${d.Area || '<span class="text-faint">‚Äî</span>'}</td>
            <td class="col-hide-mobile">
                ${d.piso != null ? `<span class="badge badge-info" style="font-size:.68rem;">Piso ${d.piso}</span>` : '<span class="text-faint">‚Äî</span>'}
            </td>
            <td class="col-hide-mobile">
                <div class="flex items-center gap-2">
                    <span class="loc-color-dot" style="background:${colorHex};"></span>
                    <span class="font-mono" style="font-size:.76rem;color:var(--clr-text-muted);">${colorHex}</span>
                </div>
            </td>
            <td class="col-hide-mobile">
                <span class="font-mono" style="font-weight:600;">${totalEq}</span>
            </td>
            <td>
                ${isActive
                    ? '<span class="badge badge-activo">Activa</span>'
                    : '<span class="badge badge-dadodebaja">Inactiva</span>'}
            </td>
            <td style="text-align:center;">
                <div class="flex gap-2" style="justify-content:center;">
                    <button class="btn btn-ghost btn-sm btn-icon" onclick="editItem(${d.id_ubicacion})" title="Editar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="btn btn-danger btn-sm btn-icon"
                        onclick="toggleActivo(${d.id_ubicacion}, ${d.activo})"
                        title="${isActive ? 'Desactivar' : 'Activar'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            ${isActive
                                ? '<path d="M17 7 7 17M7 7l10 10"/>'
                                : '<path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/>'}
                        </svg>
                    </button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function applyFilters() {
    const s   = document.getElementById('searchInput').value.toLowerCase();
    const act = document.getElementById('filterActivo').value;
    renderTable(allData.filter(d => {
        const isActive   = d.activo === true || d.activo === 1;
        const matchS     = !s || [d.Nombre_ubicacion, d.Area, d.descripcion].some(v => (v||'').toLowerCase().includes(s));
        const matchActivo= act === '' || String(isActive ? 1 : 0) === act;
        return matchS && matchActivo;
    }));
}
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('filterActivo').addEventListener('change', applyFilters);

async function openModal(mode, id = null) {
    currentId = id;
    document.getElementById('modalTitle').textContent = mode === 'create' ? 'Nueva Ubicaci√≥n' : 'Editar Ubicaci√≥n';
    document.getElementById('itemForm').reset();
    /* Valores por defecto al crear */
    document.getElementById('color').value       = '#2B7FFF';
    document.getElementById('colorPicker').value = '#2B7FFF';
    document.getElementById('icono').value        = 'building';

    if (mode === 'edit' && id) {
        const d = allData.find(u => u.id_ubicacion === id);
        if (d) {
            FIELDS.forEach(f => {
                const el = document.getElementById(f);
                if (!el) return;
                if (f === 'activo') {
                    el.value = (d.activo === true || d.activo === 1) ? 'true' : 'false';
                } else if (d[f] != null) {
                    el.value = d[f];
                }
            });
            /* Sincronizar color picker */
            if (d.color) document.getElementById('colorPicker').value = d.color;
        }
    }
    document.getElementById('modalOverlay').classList.add('open');
}
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); currentId = null; }
document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

async function saveItem() {
    const g = id => document.getElementById(id)?.value || null;
    const data = {
        Nombre_ubicacion: g('Nombre_ubicacion'),
        Area:             g('Area'),
        piso:             g('piso') ? parseInt(g('piso')) : null,
        icono:            g('icono') || 'building',
        color:            g('color') || '#2B7FFF',
        descripcion:      g('descripcion'),
        activo:           g('activo') === 'true',   // ‚Üê boolean
    };
    if (!data.Nombre_ubicacion) { showError('El nombre de la ubicaci√≥n es obligatorio.'); return; }
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loader"></span> Guardando...';
    try {
        if (currentId) {
            await API.request(`/ubicaciones/${currentId}`, { method: 'PUT', body: JSON.stringify(data) });
            showSuccess('Ubicaci√≥n actualizada.');
        } else {
            await API.request('/ubicaciones', { method: 'POST', body: JSON.stringify(data) });
            showSuccess('Ubicaci√≥n registrada.');
        }
        closeModal();
        loadData();
    } catch(err) {
        showError('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Guardar';
    }
}

function editItem(id) { openModal('edit', id); }

async function toggleActivo(id, currentActivo) {
    const isActive = currentActivo === true || currentActivo === 1;
    const ok = await confirmAction({
        title: isActive ? '¬øDesactivar ubicaci√≥n?' : '¬øActivar ubicaci√≥n?',
        message: isActive
            ? 'Los equipos asignados a esta ubicaci√≥n quedar√°n sin ubicaci√≥n activa.'
            : '¬øDeseas reactivar esta ubicaci√≥n en el sistema?',
        confirmText: isActive ? 'Desactivar' : 'Activar',
        type: isActive ? 'danger' : 'info'
    });
    if (!ok) return;
    try {
        await API.request(`/ubicaciones/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ activo: !isActive })
        });
        showSuccess(`Ubicaci√≥n ${isActive ? 'desactivada' : 'activada'}.`);
        loadData();
    } catch(err) {
        showError('Error: ' + err.message);
    }
}

loadComponents('ubicacion');
loadData();
</script>
</body>
</html>