<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accesorios - TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
</head>
<body>
<div class="airport-layout">

    <!-- â”€â”€ HEADER â”€â”€ -->
    <header class="terminal-header">
        <div class="logo-section">
            <span style="font-size:1.6rem;">ğŸ”Œ</span>
            <h1>Accesorios</h1>
        </div>
        <div class="header-actions">
            <span id="userInfo" style="font-size:var(--text-sm);color:var(--gray-600);"></span>
            <button class="btn btn-secondary btn-sm" onclick="logout()">ğŸšª Salir</button>
        </div>
    </header>

    <!-- â”€â”€ SIDEBAR COMPLETO â”€â”€ -->
    <aside class="gate-sidebar">
        <div class="sidebar-section">
            <p class="section-title">Panel</p>
            <ul class="nav-menu">
                <li class="nav-item"><a href="dashboard.html" class="nav-link">ğŸ“Š Dashboard</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <p class="section-title">Equipos</p>
            <ul class="nav-menu">
                <li class="nav-item"><a href="computador.html"  class="nav-link">ğŸ’» Computadores</a></li>
                <li class="nav-item"><a href="celular.html"     class="nav-link">ğŸ“± Celulares</a></li>
                <li class="nav-item"><a href="impresora.html"   class="nav-link">ğŸ–¨ï¸ Impresoras</a></li>
                <li class="nav-item"><a href="radio.html"       class="nav-link">ğŸ“» Radios</a></li>
                <li class="nav-item"><a href="telefono_ip.html" class="nav-link">ğŸ“ TelÃ©fonos IP</a></li>
                <li class="nav-item"><a href="tablet.html"      class="nav-link">ğŸ“² Tablets</a></li>
                <li class="nav-item"><a href="accesorios.html"  class="nav-link active">ğŸ”Œ Accesorios</a></li>
            </ul>
        </div>
        <div class="sidebar-section">
            <p class="section-title">GestiÃ³n</p>
            <ul class="nav-menu">
                <li class="nav-item"><a href="persona.html"   class="nav-link">ğŸ‘¥ Personas</a></li>
                <li class="nav-item"><a href="ubicacion.html" class="nav-link">ğŸ“ Ubicaciones</a></li>
            </ul>
        </div>
    </aside>

    <!-- â”€â”€ MAIN â”€â”€ -->
    <main class="boarding-area">
        <div class="flight-board">
            <div class="flight-board-header">
                <h2>ğŸ”Œ Lista de Accesorios</h2>
                <div style="display:flex;gap:var(--spacing-sm);flex-wrap:wrap;">
                    <input type="text" id="searchInput" placeholder="Buscar accesorio..." class="form-input" style="max-width:220px;">
                    <select id="tipoFilter" class="form-input" style="max-width:180px;">
                        <option value="">Todos los tipos</option>
                        <option value="Mouse">Mouse</option>
                        <option value="Teclado">Teclado</option>
                        <option value="Audifonos">AudÃ­fonos</option>
                        <option value="Webcam">Webcam</option>
                        <option value="Camara web">CÃ¡mara web</option>
                        <option value="Hub USB">Hub USB</option>
                        <option value="Cable HDMI">Cable HDMI</option>
                        <option value="Cable VGA">Cable VGA</option>
                        <option value="Adaptador">Adaptador</option>
                        <option value="Cargador">Cargador</option>
                        <option value="Base refrigerante">Base refrigerante</option>
                        <option value="Diadema">Diadema</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <button class="btn btn-primary" onclick="openModal()">+ Nuevo Accesorio</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Marca / Modelo</th>
                            <th>Serial</th>
                            <th>Persona asignada</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--gray-400);">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- â”€â”€ MODAL â”€â”€ -->
<div id="modal" class="modal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nuevo Accesorio</h3>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="form">
                    <input type="hidden" id="id_accesorio">

                    <div class="fgrid2">
                        <!-- TIPO: lista completa incluyendo CÃ¡mara web -->
                        <div class="form-group">
                            <label class="form-label">Tipo de accesorio *</label>
                            <select id="tipo_accesorio" class="form-input" required>
                                <option value="">â€” Seleccionar â€”</option>
                                <option value="Mouse">Mouse</option>
                                <option value="Teclado">Teclado</option>
                                <option value="Audifonos">AudÃ­fonos</option>
                                <option value="Webcam">Webcam</option>
                                <option value="Camara web">CÃ¡mara web</option>
                                <option value="Hub USB">Hub USB</option>
                                <option value="Cable HDMI">Cable HDMI</option>
                                <option value="Cable VGA">Cable VGA</option>
                                <option value="Adaptador">Adaptador</option>
                                <option value="Cargador">Cargador</option>
                                <option value="Base refrigerante">Base refrigerante</option>
                                <option value="Diadema">Diadema</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select id="estado" class="form-input">
                                <option value="Bueno">Bueno</option>
                                <option value="Nuevo">Nuevo</option>
                                <option value="Regular">Regular</option>
                                <option value="Malo">Malo</option>
                                <option value="En Bodega">En Bodega</option>
                            </select>
                        </div>
                    </div>

                    <div class="fgrid3">
                        <div class="form-group">
                            <label class="form-label">Marca</label>
                            <input type="text" id="marca" class="form-input" placeholder="Ej: Logitech">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo</label>
                            <input type="text" id="modelo" class="form-input" placeholder="Ej: MX Master 3">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Serial</label>
                            <input type="text" id="serial" class="form-input">
                        </div>
                    </div>

                    <div class="fgrid2">
                        <div class="form-group">
                            <label class="form-label">Fecha adquisiciÃ³n</label>
                            <input type="date" id="fecha_adquisicion" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cantidad</label>
                            <input type="number" id="cantidad" class="form-input" value="1" min="1">
                        </div>
                    </div>

                    <!-- PERSONA ASIGNADA â€” se carga desde la API -->
                    <div class="fgrid2">
                        <div class="form-group">
                            <label class="form-label">Persona asignada</label>
                            <select id="id_persona" class="form-input">
                                <option value="">â€” Sin asignar â€”</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">UbicaciÃ³n</label>
                            <select id="id_ubicacion" class="form-input">
                                <option value="">â€” Seleccionar â€”</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notas</label>
                        <textarea id="notas" class="form-input" rows="2" style="resize:vertical;" placeholder="Observaciones..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button type="button" class="btn btn-primary"   onclick="save()">ğŸ’¾ Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
    let accesorios = [];
    let personas   = [];
    let ubicaciones = [];
    let userRol    = null;

    const TIPO_ICON = {
        'Mouse':'ğŸ–±ï¸','Teclado':'âŒ¨ï¸','Audifonos':'ğŸ§','Webcam':'ğŸ“·','Camara web':'ğŸ“·',
        'Hub USB':'ğŸ”Œ','Cable HDMI':'ğŸ“º','Cable VGA':'ğŸ“º','Adaptador':'ğŸ”„',
        'Cargador':'ğŸ”‹','Base refrigerante':'â„ï¸','Diadema':'ğŸ™ï¸','Otro':'ğŸ“¦'
    };

    // â”€â”€ CARGAR TODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadData() {
        try {
            const userRes = await API.getMe();
            if (userRes.success) {
                document.getElementById('userInfo').textContent = userRes.data.nombre;
                userRol = userRes.data.rol;
            }
            // Cargar personas y ubicaciones para el modal
            const [pRes, uRes] = await Promise.all([
                API.getPersonas(),
                API.getUbicaciones()
            ]);
            if (pRes.success) {
                personas = pRes.data;
                const selP = document.getElementById('id_persona');
                selP.innerHTML = '<option value="">â€” Sin asignar â€”</option>';
                personas.forEach(p => {
                    selP.innerHTML += `<option value="${p.id_persona}">${p.nombre}${p.cargo ? ' â€” ' + p.cargo : ''}</option>`;
                });
            }
            if (uRes.success) {
                ubicaciones = uRes.data;
                const selU = document.getElementById('id_ubicacion');
                selU.innerHTML = '<option value="">â€” Seleccionar â€”</option>';
                ubicaciones.forEach(u => {
                    selU.innerHTML += `<option value="${u.id_ubicacion}">${u.Nombre_ubicacion}${u.Area ? ' (' + u.Area + ')' : ''}</option>`;
                });
            }

            // Cargar accesorios con filtros
            const search = document.getElementById('searchInput').value;
            const tipo   = document.getElementById('tipoFilter').value;
            const aRes   = await API.getAccesorios({ search, tipo });
            if (aRes.success) { accesorios = aRes.data; renderTable(); }
        } catch (e) { showError('Error al cargar: ' + e.message); }
    }

    // â”€â”€ TABLA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        if (!accesorios.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--gray-400);">No hay accesorios registrados</td></tr>';
            return;
        }
        const canEdit = userRol === 'admin' || userRol === 'technician';
        tbody.innerHTML = accesorios.map(a => `
            <tr>
                <td>${TIPO_ICON[a.tipo_accesorio] || 'ğŸ“¦'} <strong>${a.tipo_accesorio}</strong></td>
                <td>${a.marca || '-'} ${a.modelo ? '/ ' + a.modelo : ''}</td>
                <td style="font-family:var(--font-mono);font-size:var(--text-xs);">${a.serial || '-'}</td>
                <td>${a.nombre_usuario || '<em style="color:var(--gray-400);">Sin asignar</em>'}</td>
                <td><span class="badge ${estadoBadge(a.estado)}">${a.estado}</span></td>
                <td>
                    ${canEdit ? `<button class="btn btn-sm btn-primary" onclick='edit(${JSON.stringify(a)})'>âœï¸ Editar</button>` : ''}
                    ${userRol === 'admin' ? `<button class="btn btn-sm btn-danger" onclick="del(${a.id_accesorio})">ğŸ—‘ï¸</button>` : ''}
                </td>
            </tr>
        `).join('');
    }

    function estadoBadge(e) {
        const map = { 'Nuevo':'badge-info', 'Bueno':'badge-success', 'Regular':'badge-warning', 'Malo':'badge-danger', 'En Bodega':'badge-secondary' };
        return map[e] || 'badge-secondary';
    }

    // â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openModal(isEdit = false) {
        document.getElementById('modalTitle').textContent = isEdit ? 'Editar Accesorio' : 'Nuevo Accesorio';
        if (!isEdit) {
            document.getElementById('form').reset();
            document.getElementById('id_accesorio').value = '';
            document.getElementById('cantidad').value = '1';
        }
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    function edit(a) {
        openModal(true);
        document.getElementById('id_accesorio').value     = a.id_accesorio;
        document.getElementById('tipo_accesorio').value   = a.tipo_accesorio  || '';
        document.getElementById('marca').value            = a.marca           || '';
        document.getElementById('modelo').value           = a.modelo          || '';
        document.getElementById('serial').value           = a.serial          || '';
        document.getElementById('estado').value           = a.estado          || 'Bueno';
        document.getElementById('cantidad').value         = a.cantidad        || 1;
        document.getElementById('fecha_adquisicion').value = a.fecha_adquisicion ? a.fecha_adquisicion.split('T')[0] : '';
        document.getElementById('notas').value            = a.notas           || '';
        // Persona y ubicaciÃ³n asignadas actualmente
        document.getElementById('id_persona').value   = a.id_persona   || '';
        document.getElementById('id_ubicacion').value = a.id_ubicacion || '';
    }

    async function del(id) {
        if (!confirmAction('Â¿Dar de baja este accesorio?')) return;
        try {
            const res = await API.deleteAccesorio(id);
            if (res.success) { showSuccess('Accesorio dado de baja'); loadData(); }
        } catch (e) { showError('Error: ' + e.message); }
    }

    // â”€â”€ GUARDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function save() {
        const tipo = document.getElementById('tipo_accesorio').value;
        if (!tipo) { showError('Selecciona el tipo de accesorio'); return; }

        const id = document.getElementById('id_accesorio').value;
        const id_persona   = document.getElementById('id_persona').value   || null;
        const id_ubicacion = document.getElementById('id_ubicacion').value || null;

        const datos = {
            tipo_accesorio:   tipo,
            marca:            document.getElementById('marca').value.trim()   || null,
            modelo:           document.getElementById('modelo').value.trim()  || null,
            serial:           document.getElementById('serial').value.trim()  || null,
            estado:           document.getElementById('estado').value,
            cantidad:         parseInt(document.getElementById('cantidad').value) || 1,
            fecha_adquisicion: document.getElementById('fecha_adquisicion').value || null,
            notas:            document.getElementById('notas').value.trim()   || null,
            id_persona,
            id_ubicacion
        };

        try {
            const res = id ? await API.updateAccesorio(id, datos) : await API.createAccesorio(datos);
            if (res.success) { showSuccess(id ? 'Accesorio actualizado' : 'Accesorio creado'); closeModal(); loadData(); }
        } catch (e) { showError('Error al guardar: ' + e.message); }
    }

    document.getElementById('searchInput').addEventListener('input', loadData);
    document.getElementById('tipoFilter').addEventListener('change', loadData);

    loadData();
</script>

<style>
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:var(--z-modal);}
    .modal-dialog{background:white;border-radius:var(--radius-lg);max-width:680px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-2xl);}
    .modal-dialog::before{content:'';display:block;height:4px;background:linear-gradient(90deg,var(--airport-primary),var(--airport-accent));border-radius:var(--radius-lg) var(--radius-lg) 0 0;}
    .modal-header{padding:var(--spacing-lg) var(--spacing-xl);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;}
    .modal-header h3{font-size:var(--text-lg);font-weight:700;color:var(--gray-900);}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--gray-400);width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius-md);}
    .modal-close:hover{background:var(--gray-100);}
    .modal-body{padding:var(--spacing-xl);}
    .modal-footer{padding:var(--spacing-lg) var(--spacing-xl);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:var(--spacing-md);}
    .fgrid2{display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-md);}
    .fgrid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--spacing-md);}
    .badge{padding:4px 10px;border-radius:12px;font-size:var(--text-xs);font-weight:600;}
    .badge-success{background:#d4edda;color:#155724;} .badge-info{background:#d1ecf1;color:#0c5460;}
    .badge-warning{background:#fff3cd;color:#856404;} .badge-danger{background:#f8d7da;color:#721c24;}
    .badge-secondary{background:#e2e3e5;color:#383d41;}
    .btn-sm{padding:5px 10px;font-size:var(--text-xs);border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:600;}
    .btn-danger{background:var(--status-retired);color:white;}
    @media(max-width:600px){.fgrid2,.fgrid3{grid-template-columns:1fr;}}
</style>
</body>
</html>