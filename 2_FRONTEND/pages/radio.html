<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radios â€” TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
</head>
<body>
<div class="airport-layout">
    <div id="sidebar-placeholder"></div>
    <div id="navbar-placeholder"></div>
    <main class="app-main">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--clr-primary)" stroke-width="2"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.1 19.1 19"/></svg>
                    Radios
                </h1>
                <p class="page-subtitle" id="subtitleCount">Cargando inventario...</p>
            </div>
            <div class="flex gap-3 items-center flex-wrap">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="search" id="searchInput" placeholder="Buscar radio...">
                </div>
                <select id="filterEstado" style="width:auto;padding:.55rem .9rem;">
                    <option value="">Todos los estados</option>
                    <option value="ACTIVO">Activo</option>
                    <option value="MANTENIMIENTO">Mantenimiento</option>
                    <option value="BODEGA">Bodega</option>
                    <option value="BAJA">Baja</option>
                </select>
                <select id="filterMarca" style="width:auto;padding:.55rem .9rem;">
                    <option value="">Todas las marcas</option>
                </select>
                <button class="btn btn-primary" onclick="openModal('create')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    Nuevo Radio
                </button>
            </div>
        </div>
        <div class="card" style="padding:0;overflow:hidden;">
            <div class="table-wrapper" style="border:none;border-radius:0;">
                <table class="table">
                    <thead><tr>
                        <th>Tipo</th><th>Marca / Modelo</th><th>Serial</th>
                        <th>Frecuencia</th><th>BaterÃ­a</th><th>Accesorios</th>
                        <th>Asignado a</th><th>Estado</th><th>Activo</th>
                        <th style="text-align:center;">Acciones</th>
                    </tr></thead>
                    <tbody id="tableBody"><tr class="loading-row"><td colspan="10"><div class="loader"></div></td></tr></tbody>
                </table>
            </div>
        </div>
    </main>
    <div id="footer-placeholder"></div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal" style="max-width:680px;">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Nuevo Radio</span>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="itemForm">
                <div class="form-grid-3">
                    <div class="form-group"><label>Tipo Radio</label>
                        <select id="tipo_radio"><option value="PORTATIL">PortÃ¡til</option><option value="MOVIL">MÃ³vil</option><option value="BASE">Base</option><option value="REPETIDOR">Repetidor</option></select>
                    </div>
                    <div class="form-group"><label>Marca</label><input type="text" id="marca" placeholder="Motorola, Kenwood..."></div>
                    <div class="form-group"><label>Modelo</label><input type="text" id="modelo" placeholder="Modelo"></div>
                </div>
                <div class="form-grid-2">
                    <div class="form-group"><label>Serial Radio</label><input type="text" id="serial_radio" placeholder="Serial" style="font-family:var(--font-mono)"></div>
                    <div class="form-group"><label>Frecuencia (MHz)</label><input type="text" id="frecuencia" placeholder="Ej: 462.5625"></div>
                </div>

                <div style="border:1px solid var(--clr-border);border-radius:var(--r-md);padding:1rem;display:flex;flex-direction:column;gap:.75rem;">
                    <span style="font-size:.78rem;font-weight:700;color:var(--clr-text-muted);text-transform:uppercase;letter-spacing:.06em;">Antena</span>
                    <div class="form-grid-2">
                        <label style="display:flex;align-items:center;gap:.5rem;font-size:.83rem;cursor:pointer;text-transform:none;font-weight:400;">
                            <input type="checkbox" id="antena" checked> Incluye Antena
                        </label>
                        <div class="form-group"><label>Estado Antena</label>
                            <select id="estado_antena"><option value="BUENO">Bueno</option><option value="FUNCIONAL">Funcional</option><option value="MALO">Malo</option></select>
                        </div>
                    </div>
                </div>

                <div style="border:1px solid var(--clr-border);border-radius:var(--r-md);padding:1rem;display:flex;flex-direction:column;gap:.75rem;">
                    <span style="font-size:.78rem;font-weight:700;color:var(--clr-text-muted);text-transform:uppercase;letter-spacing:.06em;">BaterÃ­a</span>
                    <div class="form-grid-3">
                        <div class="form-group"><label>Ref. BaterÃ­a</label><input type="text" id="bateria" placeholder="Referencia"></div>
                        <div class="form-group"><label>Serial BaterÃ­a</label><input type="text" id="serial_bateria" placeholder="S/N" style="font-family:var(--font-mono)"></div>
                        <div class="form-group"><label>Estado BaterÃ­a</label>
                            <select id="estado_bateria"><option value="BUENO">Bueno</option><option value="FUNCIONAL">Funcional</option><option value="MALO">Malo</option></select>
                        </div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;">
                    <label style="display:flex;align-items:center;gap:.5rem;font-size:.83rem;cursor:pointer;text-transform:none;font-weight:400;">
                        <input type="checkbox" id="diadema_manos_libres"> Diadema / Manos Libres
                    </label>
                    <label style="display:flex;align-items:center;gap:.5rem;font-size:.83rem;cursor:pointer;text-transform:none;font-weight:400;">
                        <input type="checkbox" id="base_cargador"> Base Cargador
                    </label>
                </div>
                <div class="form-group"><label>Serial Cargador</label><input type="text" id="serial_cargador" placeholder="Serial base cargador" style="font-family:var(--font-mono)"></div>

                <div class="form-grid-3">
                    <div class="form-group"><label>Estado del Equipo</label>
                        <select id="estado"><option value="NUEVO">Nuevo</option><option value="BUENO" selected>Bueno</option><option value="FUNCIONAL">Funcional</option><option value="MALO">Malo</option></select>
                    </div>
                    <div class="form-group"><label>Fecha AdquisiciÃ³n</label><input type="date" id="fecha_adquisicion"></div>
                    <div class="form-group"><label>Ãšltimo Mantenimiento</label><input type="date" id="ultimo_mantenimiento"></div>
                </div>
                <div class="form-group"><label>Actividad</label>
                    <select id="activo"><option value="ACTIVO" selected>Activo</option><option value="MANTENIMIENTO">Mantenimiento</option><option value="BODEGA">Bodega</option><option value="BAJA">Baja</option></select>
                </div>
                <div class="divider"></div>
                <div class="form-group"><label>Persona Asignada</label><select id="id_persona"><option value="">â€” Sin asignar â€”</option></select></div>
                <div class="form-group"><label>UbicaciÃ³n</label><select id="id_ubicacion"><option value="">â€” Seleccionar â€”</option></select></div>
                <div class="form-group"><label>Notas</label><textarea id="notas" placeholder="Observaciones..."></textarea></div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" id="saveBtn" onclick="saveItem()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                Guardar
            </button>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
let allData=[], currentId=null;
const TEXT_FIELDS=['tipo_radio','marca','modelo','serial_radio','frecuencia','estado_antena','bateria','serial_bateria','estado_bateria','serial_cargador','estado','activo','id_persona','id_ubicacion','fecha_adquisicion','ultimo_mantenimiento','notas'];
const BOOL_FIELDS=['antena','diadema_manos_libres','base_cargador'];

async function loadData(){
    const tbody=document.getElementById('tableBody');
    tbody.innerHTML=`<tr class="loading-row"><td colspan="10"><div class="loader"></div></td></tr>`;
    try{
        const res=await API.getRadios();
        allData=res.data||[];
        populateMarcas(allData);
        applyFilters();
        document.getElementById('subtitleCount').textContent=`${allData.length} radio${allData.length!==1?'s':''} registrado${allData.length!==1?'s':''}`;
    }catch(e){tbody.innerHTML=`<tr><td colspan="10" class="text-muted" style="text-align:center;padding:2rem;">Error al cargar datos</td></tr>`;}
}

function populateMarcas(data) {
    const sel = document.getElementById('filterMarca');
    const current = sel.value;
    const marcas = [...new Set(data.map(d => d.marca).filter(Boolean).map(m => m.trim()))].sort();
    sel.innerHTML = '<option value="">Todas las marcas</option>' +
        marcas.map(m => `<option value="${m}"${m === current ? ' selected' : ''}>${m}</option>`).join('');
}

function getBadge(v){if(!v)return'<span class="badge badge-storage">â€”</span>';return`<span class="badge badge-${v.toLowerCase().replace(/\s/g,'')}">${v}</span>`;}

function renderTable(data){
    const tbody=document.getElementById('tableBody');
    if(!data.length){tbody.innerHTML=`<tr><td colspan="10"><div class="empty-state"><div class="empty-state-icon">ðŸ“»</div><div class="empty-state-title">Sin radios registrados</div></div></td></tr>`;return;}
    tbody.innerHTML=data.map(d=>`<tr class="animate-fade">
        <td>${d.tipo_radio||'â€”'}</td>
        <td><div style="font-weight:500;">${d.marca||'â€”'}</div><div class="text-faint" style="font-size:.75rem;">${d.modelo||''}</div></td>
        <td><span class="font-mono">${d.serial_radio||'â€”'}</span></td>
        <td><span class="font-mono">${d.frecuencia||'â€”'}</span></td>
        <td>${d.bateria||'â€”'} ${d.estado_bateria?getBadge(d.estado_bateria):''}</td>
        <td>
            ${d.antena?'<span class="badge badge-activo">Antena</span> ':''} 
            ${d.diadema_manos_libres?'<span class="badge badge-info">Diadema</span> ':''} 
            ${d.base_cargador?'<span class="badge badge-info">Base</span>':''}
        </td>
        <td>${d.nombre_usuario||'<span class="text-faint">Sin asignar</span>'}</td>
        <td>${getBadge(d.estado)}</td><td>${getBadge(d.activo)}</td>
        <td style="text-align:center;"><div class="flex gap-2" style="justify-content:center;">
            <button class="btn btn-ghost btn-sm btn-icon" onclick="openQRModal('radio',${d.id_radio},${d.tipo_radio||d.marca||'Equipo'})" title="Ver QR"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="15" height="15"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="2" height="2"/><rect x="18" y="14" width="2" height="2"/><rect x="14" y="18" width="2" height="2"/><rect x="18" y="18" width="2" height="2"/></svg></button>
            <button class="btn btn-ghost btn-sm btn-icon" onclick="editItem(${d.id_radio})" title="Editar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
            <button class="btn btn-danger btn-sm btn-icon" onclick="deleteItem(${d.id_radio})" title="Baja"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg></button>
        </div></td>
    </tr>`).join('');
}

function applyFilters(){
    const s=document.getElementById('searchInput').value.toLowerCase();
    const e=document.getElementById('filterEstado').value;
    const m=document.getElementById('filterMarca').value;
    renderTable(allData.filter(d=>
        (!s||[d.marca,d.modelo,d.serial_radio,d.tipo_radio,d.nombre_usuario].some(v=>(v||'').toLowerCase().includes(s)))&&
        (!e||d.activo===e)&&
        (!m||d.marca===m)
    ));
}
document.getElementById('searchInput').addEventListener('input',applyFilters);
document.getElementById('filterEstado').addEventListener('change',applyFilters);
document.getElementById('filterMarca').addEventListener('change',applyFilters);

async function openModal(mode,id=null){
    currentId=id;
    document.getElementById('modalTitle').textContent=mode==='create'?'Nuevo Radio':'Editar Radio';
    document.getElementById('itemForm').reset();
    document.getElementById('antena').checked=true;
    try{
        const[pRes,uRes]=await Promise.all([API.getPersonas(),API.getUbicaciones()]);
        if(pRes.success)document.getElementById('id_persona').innerHTML=`<option value="">â€” Sin asignar â€”</option>`+pRes.data.map(p=>`<option value="${p.id_persona}">${p.nombre}</option>`).join('');
        if(uRes.success)document.getElementById('id_ubicacion').innerHTML=`<option value="">â€” Seleccionar â€”</option>`+uRes.data.map(u=>`<option value="${u.id_ubicacion}">${u.Nombre_ubicacion||u.nombre}</option>`).join('');
    }catch(e){}
    if(mode==='edit'&&id){
        const d=allData.find(c=>c.id_radio===id);
        if(d){
            TEXT_FIELDS.forEach(f=>{const el=document.getElementById(f);if(el&&d[f]!=null)el.value=d[f];});
            BOOL_FIELDS.forEach(f=>{const el=document.getElementById(f);if(el)el.checked=!!d[f];});
        }
    }
    document.getElementById('modalOverlay').classList.add('open');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('open');currentId=null;}
document.getElementById('modalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});

async function saveItem(){
    const g=id=>document.getElementById(id)?.value||null;
    const data={...Object.fromEntries(TEXT_FIELDS.map(f=>[f,g(f)])),...Object.fromEntries(BOOL_FIELDS.map(f=>[f,document.getElementById(f)?.checked||false]))};
    const btn=document.getElementById('saveBtn');
    btn.disabled=true;btn.innerHTML='<span class="loader"></span> Guardando...';
    try{
        if(currentId){await API.update(`/radios/${currentId}`,data);showSuccess('Radio actualizado.');}
        else{await API.create('/radios',data);showSuccess('Radio registrado.');}
        closeModal();loadData();
    }catch(err){showError('Error: '+err.message);}
    finally{btn.disabled=false;btn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Guardar';}
}
function editItem(id){openModal('edit',id);}
async function deleteItem(id){
    if(!confirm('Â¿Confirmas dar de baja este radio?'))return;
    try{await API.delete(`/radios/${id}`);showSuccess('Radio dado de baja.');loadData();}
    catch(err){showError('Error: '+err.message);}
}
loadComponents('radio');loadData();
</script>
</body>
</html>