<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computadores â€” TICS Aeropuerto</title>
    <link rel="stylesheet" href="../assets/css/airport-theme.css">
</head>
<body>
<div class="airport-layout">
    <div id="sidebar-placeholder"></div>
    <div id="navbar-placeholder"></div>

    <main class="app-main">

        <!-- Encabezado de pÃ¡gina -->
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--clr-primary)" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    Computadores
                </h1>
                <p class="page-subtitle" id="subtitleCount">Cargando inventario...</p>
            </div>
            <div class="flex gap-3 items-center flex-wrap">
                <div class="search-bar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input type="search" id="searchInput" placeholder="Buscar computador...">
                </div>
                <select id="filterEstado" style="width: auto; padding: 0.55rem 0.9rem;">
                    <option value="">Todos los estados</option>
                    <option value="ACTIVO">Activo</option>
                    <option value="MANTENIMIENTO">Mantenimiento</option>
                    <option value="BODEGA">Bodega</option>
                    <option value="BAJA">Baja</option>
                </select>
                <button class="btn btn-primary" onclick="openModal('create')">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Nuevo Computador
                </button>
            </div>
        </div>

        <!-- Tabla -->
        <div class="card" style="padding: 0; overflow: hidden;">
            <div class="table-wrapper" style="border: none; border-radius: 0;">
                <table class="table" id="computadoresTable">
                    <thead>
                        <tr>
                            <th>CÃ³digo Activo</th>
                            <th>Equipo</th>
                            <th>Marca / Modelo</th>
                            <th>Serial</th>
                            <th>Usuario Asignado</th>
                            <th>UbicaciÃ³n</th>
                            <th>Estado</th>
                            <th>Activo</th>
                            <th style="text-align:center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="computadoresBody">
                        <tr class="loading-row">
                            <td colspan="9">
                                <div class="flex-center gap-3" style="flex-direction: column; padding: 3rem;">
                                    <div class="loader"></div>
                                    <span>Cargando inventario...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Nuevo Computador</span>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="computadorForm">

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>CÃ³digo Activo *</label>
                        <input type="text" id="codigo_activo" placeholder="Ej: COMP-001" required>
                    </div>
                    <div class="form-group">
                        <label>Nombre del Equipo</label>
                        <input type="text" id="nombre_equipo" placeholder="Ej: PC-Administrativo">
                    </div>
                </div>

                <div class="form-grid-3">
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="marca_equipo" placeholder="HP, Dell, Lenovo...">
                    </div>
                    <div class="form-group">
                        <label>Modelo</label>
                        <input type="text" id="modelo_equipo" placeholder="Modelo">
                    </div>
                    <div class="form-group">
                        <label>Serial</label>
                        <input type="text" id="serial_equipo" placeholder="N/S">
                    </div>
                </div>

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>DirecciÃ³n IP</label>
                        <input type="text" id="ip_equipo" placeholder="192.168.1.x">
                    </div>
                    <div class="form-group">
                        <label>MAC Address</label>
                        <input type="text" id="mac_equipo" placeholder="XX:XX:XX:XX:XX:XX" style="font-family: var(--font-mono);">
                    </div>
                </div>

                <div class="form-grid-3">
                    <div class="form-group">
                        <label>RAM (GB)</label>
                        <input type="number" id="ram" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label>Disco (GB)</label>
                        <input type="number" id="disco" placeholder="512">
                    </div>
                    <div class="form-group">
                        <label>Procesador</label>
                        <input type="text" id="procesador" placeholder="i5, Ryzen...">
                    </div>
                </div>

                <div class="form-grid-2">
                    <div class="form-group">
                        <label>Estado del Equipo</label>
                        <select id="estado">
                            <option value="NUEVO">Nuevo</option>
                            <option value="BUENO" selected>Bueno</option>
                            <option value="FUNCIONAL">Funcional</option>
                            <option value="MALO">Malo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado de Actividad</label>
                        <select id="activo">
                            <option value="ACTIVO" selected>Activo</option>
                            <option value="MANTENIMIENTO">Mantenimiento</option>
                            <option value="BODEGA">Bodega</option>
                            <option value="BAJA">Baja</option>
                        </select>
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>Persona Asignada</label>
                    <select id="id_persona">
                        <option value="">â€” Sin asignar â€”</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>UbicaciÃ³n</label>
                    <select id="id_ubicacion">
                        <option value="">â€” Seleccionar ubicaciÃ³n â€”</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="observaciones" placeholder="Notas adicionales..."></textarea>
                </div>

            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveComputador()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Guardar
            </button>
        </div>
    </div>
</div>

<script src="../assets/js/api.js"></script>
<script src="../assets/js/components.js"></script>
<script>
let allData = [];
let currentId = null;

// â”€â”€ Cargar datos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadComputadores() {
    const tbody = document.getElementById('computadoresBody');
    tbody.innerHTML = `<tr class="loading-row"><td colspan="9"><div class="loader"></div></td></tr>`;

    try {
        const res = await API.getComputadores();
        if (!res.success) throw new Error();
        allData = res.data || [];
        renderTable(allData);
        document.getElementById('subtitleCount').textContent =
            `${allData.length} equipo${allData.length !== 1 ? 's' : ''} registrado${allData.length !== 1 ? 's' : ''}`;
    } catch(e) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-muted" style="text-align:center; padding:2rem;">Error al cargar datos</td></tr>`;
    }
}

// â”€â”€ Renderizar tabla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(data) {
    const tbody = document.getElementById('computadoresBody');

    if (!data.length) {
        tbody.innerHTML = `
            <tr><td colspan="9">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’»</div>
                    <div class="empty-state-title">Sin computadores registrados</div>
                    <div class="empty-state-sub">Agrega el primero con el botÃ³n "Nuevo Computador"</div>
                </div>
            </td></tr>`;
        return;
    }

    tbody.innerHTML = data.map(item => `
        <tr class="animate-fade">
            <td><span class="font-mono">${item.codigo_activo || 'â€”'}</span></td>
            <td>${item.nombre_equipo || 'â€”'}</td>
            <td>
                <div style="font-weight:500;">${item.marca_equipo || 'â€”'}</div>
                <div class="text-faint" style="font-size:0.75rem;">${item.modelo_equipo || ''}</div>
            </td>
            <td><span class="font-mono">${item.serial_equipo || 'â€”'}</span></td>
            <td>${item.nombre_usuario || '<span class="text-faint">Sin asignar</span>'}</td>
            <td>${item.Nombre_ubicacion || '<span class="text-faint">â€”</span>'}</td>
            <td>${getBadge(item.estado)}</td>
            <td>${getBadge(item.activo)}</td>
            <td style="text-align:center;">
                <div class="flex gap-2" style="justify-content:center;">
                    <button class="btn btn-ghost btn-sm btn-icon" onclick="editComputador(${item.id_computador})" title="Editar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </button>
                    <button class="btn btn-danger btn-sm btn-icon" onclick="deleteComputador(${item.id_computador})" title="Dar de baja">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                            <path d="M10 11v6M14 11v6"/>
                            <path d="M9 6V4h6v2"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getBadge(val) {
    if (!val) return '<span class="badge badge-storage">â€”</span>';
    const cls = val.toLowerCase().replace(/\s/g,'');
    return `<span class="badge badge-${cls}">${val}</span>`;
}

// â”€â”€ BÃºsqueda y filtro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const estado = document.getElementById('filterEstado').value;

    const filtered = allData.filter(item => {
        const matchSearch = !search ||
            (item.codigo_activo || '').toLowerCase().includes(search) ||
            (item.nombre_equipo || '').toLowerCase().includes(search) ||
            (item.marca_equipo || '').toLowerCase().includes(search) ||
            (item.serial_equipo || '').toLowerCase().includes(search) ||
            (item.nombre_usuario || '').toLowerCase().includes(search);

        const matchEstado = !estado || item.activo === estado;
        return matchSearch && matchEstado;
    });

    renderTable(filtered);
}

document.getElementById('searchInput').addEventListener('input', applyFilters);
document.getElementById('filterEstado').addEventListener('change', applyFilters);

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openModal(mode, id = null) {
    currentId = id;
    document.getElementById('modalTitle').textContent = mode === 'create' ? 'Nuevo Computador' : 'Editar Computador';
    document.getElementById('computadorForm').reset();

    // Cargar personas y ubicaciones
    try {
        const [pRes, uRes] = await Promise.all([API.getPersonas(), API.getUbicaciones()]);

        if (pRes.success) {
            document.getElementById('id_persona').innerHTML =
                `<option value="">â€” Sin asignar â€”</option>` +
                pRes.data.map(p => `<option value="${p.id_persona}">${p.nombre}</option>`).join('');
        }
        if (uRes.success) {
            document.getElementById('id_ubicacion').innerHTML =
                `<option value="">â€” Seleccionar ubicaciÃ³n â€”</option>` +
                uRes.data.map(u => `<option value="${u.id_ubicacion}">${u.Nombre_ubicacion || u.nombre}</option>`).join('');
        }
    } catch(e) { /* no bloqueante */ }

    // Si es editar, rellenar con datos actuales
    if (mode === 'edit' && id) {
        const item = allData.find(c => c.id_computador === id);
        if (item) {
            ['codigo_activo','nombre_equipo','marca_equipo','modelo_equipo','serial_equipo',
             'ip_equipo','mac_equipo','ram','disco','procesador','estado','activo',
             'id_persona','id_ubicacion','observaciones'].forEach(field => {
                const el = document.getElementById(field);
                if (el && item[field] !== undefined && item[field] !== null) el.value = item[field];
            });
        }
    }

    document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
    currentId = null;
}

// Cerrar al hacer click fuera
document.getElementById('modalOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
});

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveComputador() {
    const data = {
        codigo_activo:  document.getElementById('codigo_activo').value,
        nombre_equipo:  document.getElementById('nombre_equipo').value,
        marca_equipo:   document.getElementById('marca_equipo').value,
        modelo_equipo:  document.getElementById('modelo_equipo').value,
        serial_equipo:  document.getElementById('serial_equipo').value,
        ip_equipo:      document.getElementById('ip_equipo').value,
        mac_equipo:     document.getElementById('mac_equipo').value,
        ram:            document.getElementById('ram').value || null,
        disco:          document.getElementById('disco').value || null,
        procesador:     document.getElementById('procesador').value,
        estado:         document.getElementById('estado').value,
        activo:         document.getElementById('activo').value,
        id_persona:     document.getElementById('id_persona').value || null,
        id_ubicacion:   document.getElementById('id_ubicacion').value || null,
        observaciones:  document.getElementById('observaciones').value,
    };

    if (!data.codigo_activo) {
        showError('El cÃ³digo activo es obligatorio.');
        return;
    }

    const saveBtn = document.querySelector('.modal-footer .btn-primary');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="loader"></span> Guardando...';

    try {
        if (currentId) {
            await API.update(`/computadores/${currentId}`, data);
            showSuccess('Computador actualizado correctamente.');
        } else {
            await API.create('/computadores', data);
            showSuccess('Computador registrado correctamente.');
        }
        closeModal();
        loadComputadores();
    } catch(err) {
        showError('Error al guardar: ' + err.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Guardar`;
    }
}

async function editComputador(id) {
    openModal('edit', id);
}

async function deleteComputador(id) {
    const ok = await confirmAction({
        title: 'Â¿Dar de baja computador?',
        message: 'Esta acciÃ³n desactivarÃ¡ el equipo y se registrarÃ¡ en el historial.',
        confirmText: 'Dar de baja',
        type: 'danger'
    });
    if (!ok) return;
    try {
        await API.delete(`/computadores/${id}`);
        showSuccess('Computador dado de baja.');
        loadComputadores();
    } catch(err) {
        showError('Error al dar de baja: ' + err.message);
    }
}

// â”€â”€ Toast helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSuccess(msg) { _toast(msg, 'toast-success', 'âœ”'); }
function showError(msg)   { _toast(msg, 'toast-error', 'âœ–'); }

function _toast(msg, cls, icon) {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    const t = document.createElement('div');
    t.className = `toast ${cls}`;
    t.innerHTML = `<span class="toast-icon">${icon}</span><span class="toast-msg">${msg}</span><span class="toast-close" onclick="this.parentElement.remove()">Ã—</span>`;
    container.appendChild(t);
    setTimeout(() => t.remove(), 4000);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadComponents('computador');
loadComputadores();
</script>
</body>
</html>